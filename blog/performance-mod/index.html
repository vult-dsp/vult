 <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://kit.fontawesome.com/aeb7435d58.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="../../css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="../../javascripts/bootstrap.min.js"></script>
<link rel="shortcut icon" href="../../images/favicon.ico" />
<script async src="https://ackee.vultiverse.com/tracker.js" data-ackee-server="https://ackee.vultiverse.com" data-ackee-domain-id="6210aaa1-0604-47ae-beba-65b0dca88fc2"></script>

<nav class="navbar navbar-inverse">
   <div class="container-fluid top-menu">
      <a class="navbar-brand" href="../../"><img src="../../images/Vult-icon.png" alt="Vult" title="Vult" style="height:20px;"></a>

      
      <div class="navbar-header">
         <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"
            aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      </div>

      
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">

         <ul class="nav navbar-nav">
            <li><a href="../../"><i class='fa fa-home'></i> Home</a></li>
            <li><a href="../../overview"><i class='fa fa-bullseye'></i> Overview</a></li>
            <li><a href="../../tutorials"><i class='fa fa-book'></i> Docs</a></li>
            <li><a href="../../blog"><i class='fa fa-newspaper-o'></i> Blog</a></li>
            <li><a href="../../demo"><i class='fa fa-code'></i>Demo</a></li>
            <li><a href="https://github.com/modlfo/vult"><i class='fa fa-code-fork'></i>Source</a></li>
            <li><a href="https://www.npmjs.com/package/vult"><i class='fa fa-download'></i>Install</a></li>
            <li><a href="https://vult-dsp.com"><i class="fas fa-microchip"></i> Store</a></li>

         </ul>
      </div>
      
   </div>
   
</nav>

<div class="container">
   <div class="row">
      <div class="col-md-2"> </div>
      <div class="col-md-8 col-md-auto">
         <h2>Performance Tips: floating-point mod</h2>
         <p>Recently I implemented in Vult a simpler way for me to measure the performance of the generated code. Running the command <code>$ make perf</code> generates code for all languages and runs it for most of the examples.</p>

<p></p>

<p>The results are displayed in ms/s (milliseconds taken to render one second of audio). For most of the examples the C++ with fixed-point is the fastest. In a few instances is slower than C++ with floating point. I&rsquo;m still investigating these cases. LuaJIT is slightly slower than C++ and then comes JavaScript.</p>

<p>When rendering the different implementations of Saw wave oscillators we get the following result (MacBook Air with 1,4 GHz Intel Core i5):</p>

<table class="table">
<thead>
   <tr> <th> Algorithm </th> <th> C++ float </th> <th> C++ fixed</th> <th> LuaJIT</th> <th> JavaScript</th> </tr>
</thead>
<tbody>
   <tr> <td> Saw EPTR </td> <td> 0.368 ms/s  </td> <td> 0.264 ms/s </td> <td> 0.418 ms/s </td> <td>  0.539 ms/s </td> </tr>
   <tr> <td> Saw PTR W=1</td> <td> 0.385 ms/s  </td> <td> 0.255 ms/s </td> <td> 0.396 ms/s </td> <td> 0.583 ms/s </td> </tr>
   <tr> <td> Saw PTR W=2</td> <td> 0.384 ms/s  </td> <td> 0.286 ms/s </td> <td> 0.434 ms/s </td> <td> 1.057 ms/s </td> </tr>
   <tr> <td> Saw R?</td> <td> <b>0.821</b> ms/s  </td> <td> <b>0.284</b> ms/s </td> <td> 0.446 ms/s </td> <td> 1.523 ms/s </td> </tr>
   <tr> <td> Saw BLIT</td> <td> 1.593 ms/s  </td> <td> 1.729 ms/s </td> <td> 1.866 ms/s </td> <td> 3.229 ms/s </td> </tr>
</tbody>
</table>


<figure >
    
        <img src="../../images/saw_perf.png" />
    
    
</figure>


<p>A few strange things can be spotted by looking at the table. The Saw PRT gets almost twice as slow for Js. I&rsquo;m not gonna investigate that one here. The one that is more interesting is the Saw R? going from fixed-point to floating-point; it gets 3 to 4 times slower.</p>

<p>The implementation (part of it) looks as follows:</p>

<div class="vult_code" id="snipet-1"> // File: saw_r.vult
fun process(cv) {
   mem inc;
   if(Util.change(cv))
      inc = Util.cvToRate(cv);
   val i = if inc < eps() then eps() else inc;
   // generate a ramp from -1.0  to 1.0
   mem phase = (2.0 * inc + phase) % 2.0;
   val ph = phase - 1.0;
   val o = 0.0;
   ...
   ...
}
</div>

<p>After playing a bit I found the problem. The line <code>mem phase = (2.0 * inc + phase) % 2.0;</code> uses the <code>mod</code> operation on a floating-point number in order to wrap the phase. When this is converted to fixed-point (integers) the <code>mod</code> operation is performed on integers which is much faster than on floating-point.</p>

<p>By changing that line to the following lines:</p>

<div class="vult_code" id="snipet-2">mem phase = (2.0 * inc + phase);
phase = if phase > 2.0 then phase - 2.0 else phase;</div>

<p>we avoid calling <code>fmod</code> which seems to be more expensive. This will make the fixed-point a little bit slower, but the floating-point becomes faster. The updated table after performing the change is as follows:</p>

<table class="table">
<thead>
   <tr> <th> Algorithm </th> <th> C++ float </th> <th> C++ fixed</th> <th> LuaJIT</th> <th> JavaScript</th> </tr>
</thead>
<tbody>
   <tr> <td> Saw R?</td> <td> 0.426 ms/s  </td> <td> 0.322 ms/s </td> <td> 0.446 ms/s </td> <td> 1.149 ms/s </td> </tr>
</tbody>
</table>

<h2 id="conclusion">Conclusion</h2>

<p>Avoid using <code>%</code> (mod on floats) unless is strictly necessary.</p>

<h2 id="used-band-limited-algorithms">Used Band Limited Algorithms</h2>

<p>EPTR : Efficient Polynomial Transition Regions</p>

<p>PTR : Polynomial Transition Regions</p>

<p>BLIT : Band-Limited Impulse Train</p>

<p>R? : I don&rsquo;t know the name of this algorithm</p>

<p>Among these algorithms, the only one that produces real band-limited waveforms is the BLIT.</p>

<script type="text/javascript" src="../../javascripts/external/ace/ace.js"></script>
<script type="text/javascript" src="../../javascripts/main.js"></script> <div id="disqus_thread"></div>
<script type="text/javascript">
   (function () {
      
      
      if (window.location.hostname == "localhost")
         return;

      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      var disqus_shortname = 'vult-dsp';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
   })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

      </div>
   </div>
</div>


<link rel="stylesheet" type="text/css" href="../../css/vult.css">
<div class="container footer">Check our hardware at the <a href="https://vult-dsp.com/"> Vult-DSP </a> site</div>