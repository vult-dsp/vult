<link rel="stylesheet" type="text/css" href="../../css/vult.css" media="screen">

<div class="header">
	<center><img src="../../images/VultH.png" alt="Vult" title="Vult" align="middle"></center>
</div>

<link href="https://fonts.googleapis.com/css?family=Francois+One|Rasa" rel="stylesheet">
<script src="https://use.fontawesome.com/aa67c38f9b.js"></script>
<div class="menu" align="middle">
  <ul>
    <li><a href="../../"><i class='fa fa-home'></i> Home</a></li>
    <li><a href="../../overview"><i class='fa fa-bullseye'></i> Overview</a></li>
    <li><a href="../../tutorials"><i class='fa fa-book'></i> Tutorials</a></li>
    <li><a href="../../blog"><i class='fa fa-newspaper-o'></i> Blog</a></li>
    <li><a href="../../demo"><i class='fa fa-code'></i>Live Demo</a></li>
    <li><a href="https://github.com/modlfo/vult"><i class='fa fa-code-fork'></i>Source</a></li>
  </ul>
</div>

<div class="content">
    <h2>LuaJIT as backend for Vult</h2>
  <p>I have been keeping an eye in LuaJIT (<a href="http://luajit.org">http://luajit.org</a>) for some time. It&rsquo;s a very interesting project and I have read very good things about it. Some time ago I made a small benchmark comparing an optimized algorithm written in C++11 against a lazy coded version in OCaml and LuaJIT. In case you are curious here are the results:</p>

<table>
<thead>
<tr>
<th>Language</th>
<th>Execution Time</th>
<th>Lines of Code</th>
</tr>
</thead>

<tbody>
<tr>
<td>C++11</td>
<td>0.355 s</td>
<td>180</td>
</tr>

<tr>
<td>OCaml</td>
<td>0.54 s</td>
<td>63</td>
</tr>

<tr>
<td>LuaJIT</td>
<td>0.78 s</td>
<td>85</td>
</tr>
</tbody>
</table>

<p>Here&rsquo;s a chart that plots the lines of code against the execution time.</p>


<figure >
    
        <img src="../../images/benchmark1.svg" />
    
    
</figure>


<p>I have to remark again: <em>The OCaml and Lua code were not written with optimization in mind</em>. My intention was to see how fast they program could go without putting to much effort coding.</p>

<p>One can see that the C++ code is much larger. On the other hand, the OCaml code is very compact. The main reason was that in OCaml I used algebraic data types which neither Lua or C++ have (<a href="https://en.wikipedia.org/wiki/Algebraic_data_type">https://en.wikipedia.org/wiki/Algebraic_data_type</a>). Therefore, all the complex data types needed to be implemented with classes or tables in the case of Lua.</p>

<p>Recently I implemented a prototype of code generation Vult -&gt; Lua in order to check if LuaJIT could be used to create a better live coding environment. I took the JavaScript generator and with a few modifications I got Lua support.</p>

<p>To generate Lua code you need to call Vult as follows:</p>

<pre><code>$ ./vultc.native -luacode code.vult -o code
</code></pre>

<p>In order to check the performance I took one of the examples I have in Vult and made a test rendering 1000 s of audio. Here are the results:</p>

<table>
<thead>
<tr>
<th>Language</th>
<th>Execution Time</th>
</tr>
</thead>

<tbody>
<tr>
<td>C++11</td>
<td>2.77 s</td>
</tr>

<tr>
<td>LuaJIT</td>
<td>3.55 s</td>
</tr>
</tbody>
</table>

<p>Here&rsquo;s the graphic view:</p>


<figure >
    
        <img src="../../images/benchmark2.svg" />
    
    
</figure>


<p>The results are quite promising. The code was pure Lua with exception of the arrays which are implemented using the LuaJIT FFI as <code>double[]</code>. One important thing to notice is that the LuaJIT performs all operations in <code>double</code> precision, while the C/C++ uses <code>float</code>. I&rsquo;m not sure if this has a big impact or not in modern processors.</p>

<p>As follow up in this topic, I&rsquo;m planning to do more testing to see if I can generate code that is faster in LuaJIT taking advantage of the FFI features. I&rsquo;m gonna try as well to find a nice way of integrating LuaJIT + Vult into a VST or a PD external.</p>

</div>

<script src="https://apis.google.com/js/plusone.js"></script>

<center><div id="comments"></div></center>
<script>
gapi.comments.render('comments', {
    href: window.location,
    width: '624',
    first_party_property: 'BLOGGER',
    view_type: 'FILTERED_POSTMOD'
});
</script>

