 <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://kit.fontawesome.com/aeb7435d58.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="../../css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="../../javascripts/bootstrap.min.js"></script>
<link rel="shortcut icon" href="../../images/favicon.ico" />

<nav class="navbar navbar-inverse">
   <div class="container-fluid top-menu">
      <a class="navbar-brand" href="../../"><img src="../../images/Vult-icon.png" alt="Vult" title="Vult" style="height:20px;"></a>

      
      <div class="navbar-header">
         <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"
            aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      </div>

      
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">

         <ul class="nav navbar-nav">
            <li><a href="https://vult-dsp.github.io/vult/"><i class='fa fa-home'></i> Home</a></li>
            <li><a href="https://vult-dsp.github.io/vult/overview/"><i class='fa fa-bullseye'></i> Overview</a></li>
            <li><a href="https://vult-dsp.github.io/vult/tutorials/"><i class='fa fa-book'></i> Docs</a></li>
            <li><a href="https://vult-dsp.github.io/vult/blog/"><i class='fa fa-newspaper-o'></i> Blog</a></li>
            <li><a href="https://vult-dsp.github.io/vult/demo/"><i class='fa fa-code'></i>Demo</a></li>
            <li><a href="https://github.com/vult-dsp/vult"><i class='fa fa-code-fork'></i>Source</a></li>
            <li><a href="https://www.npmjs.com/package/vult"><i class='fa fa-download'></i>Install</a></li>
            <li><a href="https://vult-dsp.com"><i class="fas fa-microchip"></i> Store</a></li>

         </ul>
      </div>
      
   </div>
   
</nav>

<div class="container">
   <div class="row">
      <div class="col-md-2"> </div>
      <div class="col-md-8 col-md-auto">
         <h2>LuaJIT as backend for Vult</h2>
         <p>I have been keeping an eye on LuaJIT (<a href="http://luajit.org">http://luajit.org</a>) for some time. It&rsquo;s a very interesting project and I have read very good things about it. Some time ago I made a small benchmark comparing an optimized algorithm written in C++11 against a lazy coded version in OCaml and LuaJIT. In case you are curious here are the results:</p>
<table class="table">
<thead>
   <tr> <th> Language </th> <th> Execution Time </th> <th> Lines of Code </th> </tr>
</thead>
<tbody>
   <tr> <td> C++11 </td> <td> 0.355 s  </td> <td> 180 </td> </tr>
   <tr> <td> OCaml </td> <td> 0.54 s  </td> <td> 63 </td> </tr>
   <tr> <td> LuaJIT </td> <td> 0.78 s  </td> <td> 85 </td> </tr>
</tbody>
</table>
<p>Here&rsquo;s a chart that plots the lines of code against the execution time.</p>
<figure><img src="../../images/benchmark1.svg"/>
</figure>

<p>I have to remark again: <em>The OCaml and Lua code were not written with optimization in mind</em>. My intention was to see how fast they program could go without putting too much effort coding.</p>
<p>One can see that the C++ code is much larger. On the other hand, the OCaml code is very compact. The main reason was that in OCaml I used algebraic data types which neither Lua or C++ have (<a href="https://en.wikipedia.org/wiki/Algebraic_data_type)">https://en.wikipedia.org/wiki/Algebraic_data_type)</a>. Therefore, all the complex data types needed to be implemented with classes or tables in the case of Lua.</p>
<p>Recently I implemented a prototype of code generation Vult -&gt; Lua in order to check if LuaJIT could be used to create a better live coding environment. I took the JavaScript generator and with a few modifications I got Lua support.</p>
<p>To generate Lua code you need to call Vult as follows:</p>
<pre tabindex="0"><code>$ ./vultc -luacode code.vult -o code
</code></pre><p>In order to check the performance I took one of the examples I have in Vult and made a test rendering 1000 s of audio. Here are the results:</p>
<table class="table">
<thead>
   <tr> <th> Language </th> <th> Execution Time </th> </tr>
</thead>
<tbody>
   <tr> <td> C++11 </td> <td> 2.77 s  </td> </tr>
   <tr> <td> LuaJIT </td> <td> 3.55 s  </td> </tr>
</tbody>
</table>
<p>Here&rsquo;s the graphic view:</p>
<figure><img src="../../images/benchmark2.svg"/>
</figure>

<p>The results are quite promising. The code was pure Lua with exception of the arrays which are implemented using the LuaJIT FFI as <code>double[]</code>. One important thing to notice is that the LuaJIT performs all operations in <code>double</code> precision, while the C/C++ uses <code>float</code>. I&rsquo;m not sure if this has a big impact or not in modern processors.</p>
<p>As follow up in this topic, I&rsquo;m planning to do more testing to see if I can generate code that is faster in LuaJIT taking advantage of the FFI features. I&rsquo;m gonna try as well to find a nice way of integrating LuaJIT + Vult into a VST or a PD external.</p> 

      </div>
   </div>
</div>


<link rel="stylesheet" type="text/css" href="../../css/vult.css">
<div class="container footer">Check our main <a href="https://vult-dsp.com/"> Vult-DSP </a> site</div>