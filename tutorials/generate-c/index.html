<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://kit.fontawesome.com/aeb7435d58.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="../../css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="../../javascripts/bootstrap.min.js"></script>
<link rel="shortcut icon" href="../../images/favicon.ico" />

<nav class="navbar navbar-inverse">
   <div class="container-fluid top-menu">
      <a class="navbar-brand" href="../../"><img src="../../images/Vult-icon.png" alt="Vult" title="Vult" style="height:20px;"></a>

      
      <div class="navbar-header">
         <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"
            aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      </div>

      
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">

         <ul class="nav navbar-nav">
            <li><a href="https://vult-dsp.github.io/vult/"><i class='fa fa-home'></i> Home</a></li>
            <li><a href="https://vult-dsp.github.io/vult/overview/"><i class='fa fa-bullseye'></i> Overview</a></li>
            <li><a href="https://vult-dsp.github.io/vult/tutorials/"><i class='fa fa-book'></i> Docs</a></li>
            <li><a href="https://vult-dsp.github.io/vult/blog/"><i class='fa fa-newspaper-o'></i> Blog</a></li>
            <li><a href="https://vult-dsp.github.io/vult/demo/"><i class='fa fa-code'></i>Demo</a></li>
            <li><a href="https://github.com/vult-dsp/vult"><i class='fa fa-code-fork'></i>Source</a></li>
            <li><a href="https://www.npmjs.com/package/vult"><i class='fa fa-download'></i>Install</a></li>
            <li><a href="https://vult-dsp.com"><i class="fas fa-microchip"></i> Store</a></li>

         </ul>
      </div>
      
   </div>
   
</nav>

<div class="container">
   <div class="row">
      <div class="col-md-2"> </div>
      <div class="col-md-8 col-md-auto">
         <h2>Generating C/C&#43;&#43;</h2>
         <p>Once we have some Vult code written it&rsquo;s time to generate some C/C++ code and run it on a target.</p>
<p>If you have followed the installation steps show in <a href="https://github.com/vult-dsp/vult">https://github.com/vult-dsp/vult</a> you will have an executable called <code>vultc</code> (if you compiled it by yourself it will be <code>vultc.native</code> or <code>vultc.byte</code>). This is a simple command line application that we will use to generate the code.</p>
<p>Here is the full code of the oversampled lowpass filter which we are gonna save in a file called <code>filter.vult</code>.</p>
<div class="vult_code" id="tut5-1">
// returns true when the input changes
fun change(current:real) : bool {
   mem previous;
   val result = current <> previous;
   previous = current;
   return result;
}
<p>fun biquad(x0, b0, b1, b2 ,a1 ,a2) : real {
mem w1, w2;
val w0 = x0 - a1<em>w1 - a2</em>w2;
val y0 = b0<em>w0 + b1</em>w1 + b2*w2;
w2, w1 = w1, w0;
return y0;
}</p>
<p>fun lowpass(x,w0,q) {
mem b0,b1,b2,a1,a2;
if(change(w0) || change(q)) {
val cos_w = cos(w0);
val alpha = sin(w0)/(2.0<em>q);
val den =  1.0 + alpha;
a1 = (-2.0</em>cos_w)/den;
a2 = (1.0-alpha)/den;
b0 = (1.0-cos_w)/(2.0<em>den);
b1 = (1.0-cos_w)/den;
b2 = (1.0-cos_w)/(2.0</em>den);
}
return biquad(x,b0,b1,b2,a1,a2);
}</p>
<p>fun lowpass_2x(x,w0,q) {
val fixed_w0 = w0/2.0;
// first call to lowpass with context &lsquo;inst&rsquo;
_  = inst:lowpass(x,fixed_w0,q);
// second call to lowpass with the same context &lsquo;inst&rsquo;
val y = inst:lowpass(x,fixed_w0,q);
return y;
}</p>
</div>
<p>Next we are gonna call the Vult compiler as follows:</p>
<pre tabindex="0"><code>$ ./vultc -ccode filter.vult
</code></pre><p>The compiler receives the flag <code>-ccode</code> which instruct the compiler to generate C/C++ code. This command will print to the standard output the generated code. If we want to save it to a file we have to call the compiler as follows:</p>
<pre tabindex="0"><code>$ ./vultc -ccode filter.vult -o filter
</code></pre><p>This will generate three files: <code>filter.h</code>, <code>filter.cpp</code> and <code>filter_tables.h</code>. Vult generates many auxiliary functions and types. For each function with memory (for example a function called <code>foo</code> in the file <code>Bar.vult</code>) there&rsquo;s gonna be:</p>
<ul>
<li>a type with the name <code>Bar_foo_type</code></li>
<li>a initialization function with the name <code>Bar_foo_init</code></li>
<li>a function with the body of the original Vult function called <code>Bar_foo</code></li>
</ul>
<p>In the case of the filter example the names are: <code>Filter_lowpass_2x_type</code>, <code>Filter_lowpass_2x_init</code> and <code>Filter_lowpass_2x</code>.</p>
<p>To use this code in a file you need to:</p>
<ul>
<li>create a value of type <code>Filter_lowpass_2x_type</code></li>
<li>initialize it with the function <code>Filter_lowpass_2x_init</code></li>
<li>use it with the original function <code>Filter_lowpass_2x</code></li>
</ul>
<p>For example:</p>
<div class="c_code" id="tut5-2">// file main.cpp
<p>#include &ldquo;filter.h&rdquo;</p>
<p>int main(void) {
Filter_lowpass_2x_type filter;
// initialization
Filter_lowpass_2x_init(filter);</p>
<p>// inputs to the function
float x = 0.0f;
float w = 1.0f;
float q = 1.0f;</p>
<p>// calling the function
float result = Filter_lowpass_2x(filter,x,w,q);</p>
<p>return 0;
}</p>
</div>
<p>In order to compile this code you need to add an include directory pointing to the location of the file <code>vultin.h</code>. This file is located in the source tree under the folder <code>runtime</code>. To link you will need to compile and link the file <code>vultin.c</code> which is located in the same place (<a href="https://github.com/modlfo/vult/tree/master/runtime">https://github.com/modlfo/vult/tree/master/runtime</a>)</p>
<p>One thing to notice is that every function with memory will have as first argument a reference to a value of it&rsquo;s corresponding type. In the above case, the function <code>Filter_lowpass_2x</code> returns only one value, therefore the C/C++ will return a value. If the functions return more than one value Vult will automatically generate structures for the types. Here are few Vult functions an their corresponding C/C++ functions:</p>
<div class="vult_code" id="tut5-3">// example.vult
// single value return, no memory
fun foo1(x:real) {
	return x;
}
<p>// single value return, with memory
fun bar1(x:real) {
mem y = x;
return x;
}</p>
<p>// multiple value return, no memory
fun foo2(x:real) {
return x,x;
}</p>
<p>// multiple value return, with memory
fun bar2(x:real) {
mem y = x;
return x,x;
}</p>
</div>
<p>C/C++ declarations of the functions above:</p>
<div class="c_code" id="tut5-4">
// single value return, no memory
float Example_foo1(float x);
<p>// single value return, with memory
float Example_bar1(Example__ctx_type_1 &amp;_ctx, float x);</p>
<p>// multiple value return, no memory
void Example_foo2(Example__ctx_type_2 &amp;_ctx, float x);</p>
<p>// multiple value return, with memory
void Example_bar2(Example__ctx_type_3 &amp;_ctx, float x);</p>
</div>
<p>In the case of functions returning multiple values, the context type is always generated. In order to get the values from the context we can use the generated functions ending with <code>_ret_X</code> where <code>X</code> is the position of the returned value. For example, the functions returning multiple values show above generate:</p>
<div class="c_code" id="tut5-4.1">
// Gets the first returned value of function Example_foo2
float Example_foo2_ret_0(Example__ctx_type_2 &_ctx);
<p>// Gets the second returned value of function Example_foo2
float Example_foo2_ret_1(Example__ctx_type_2 &amp;_ctx);</p>
<p>// Gets the first returned value of function Example_bar2
float Example_bar2_ret_0(Example__ctx_type_3 &amp;_ctx);</p>
<p>// Gets the second returned value of function Example_bar2
float Example_bar2_ret_1(Example__ctx_type_3 &amp;_ctx);</p>
</div>
<p>To call the function <code>Example_foo2</code> from C++ you have to write:</p>
<div class="c_code" id="tut5-4.2">
// Declare and initialize the instance
Example_foo2_type inst;
Example_foo2_init(inst);
<p>// Call the function
Example_foo2(inst, 0.0);</p>
<p>// Retrieve the result
float value0 = Example_foo2_ret_0(inst);
float value1 = Example_foo2_ret_1(inst);</p>
</div>
<h2 id="generating-fixed-point-code">Generating fixed-point code</h2>
<p>When generating C/C++ code Vult by default uses floating point arithmetic (<code>float</code> numbers). Floating point code is very efficient in big processors like the x86. However when compiled to small microcontrollers (like the ones found in Arduinos or some ARM processors) the code can be very inefficient because these processors do not have a dedicated floating point arithmetic unit.</p>
<p>Alternatively, fixed-point calculations can be used to perform computations with decimals (like <code>2.0*1.5</code>). Fixed-point arithmetic encodes the decimal numbers as integers and uses the integer arithmetic unit in small processors to perform calculations (<a href="https://en.wikipedia.org/wiki/Fixed-point_arithmetic)">https://en.wikipedia.org/wiki/Fixed-point_arithmetic)</a>. The result is that the operations can be performed efficiently at the expense of numeric precision.</p>
<p>Vult can generate all operations with real numbers as fixed-point with the format q16.16. This means that 16 bits a used to represent integers and 16 bits for decimals. This implies that the largest number that can be represented is <code>32767.0</code> and the smallest <code>0.0000152588</code> (the values are signed). Therefore, when generating code with fixed-point numbers one needs to be careful of not going beyond this numbers.</p>
<p>To generate code with fixed-point numbers we need to call Vult as follows:</p>
<pre tabindex="0"><code>$ ./vultc -ccode -real fixed filter.vult -o filter
</code></pre><p>This command will generate use the type <code>fix16_t</code> instead of <code>float</code>. For example, the declaration of the function <code>lowpass_2x</code> changes to:</p>
<div class="c_code" id="tut5-5">
fix16_t Filter_lowpass_2x(Filter__ctx_type_3 &_ctx, fix16_t x,
                          fix16_t w0, fix16_t q);
</div>
<p>The file <code>vultin.h</code> provides functions to convert among <code>float</code> <code>fix16_t</code> and <code>int</code> values.</p>
<script type="text/javascript" src="../../javascripts/external/ace/ace.js"></script>
<script type="text/javascript" src="../../javascripts/main.js"></script> 
      </div>
   </div>
</div>

<link rel="stylesheet" type="text/css" href="../../css/vult.css">
<div class="container footer">Check our main <a href="https://vult-dsp.com/"> Vult-DSP </a> site</div>