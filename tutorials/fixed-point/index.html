<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://kit.fontawesome.com/aeb7435d58.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="../../css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="../../javascripts/bootstrap.min.js"></script>
<link rel="shortcut icon" href="../../images/favicon.ico" />

<nav class="navbar navbar-inverse">
   <div class="container-fluid top-menu">
      <a class="navbar-brand" href="../../"><img src="../../images/Vult-icon.png" alt="Vult" title="Vult" style="height:20px;"></a>

      
      <div class="navbar-header">
         <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"
            aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      </div>

      
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">

         <ul class="nav navbar-nav">
            <li><a href="https://vult-dsp.github.io/vult/"><i class='fa fa-home'></i> Home</a></li>
            <li><a href="https://vult-dsp.github.io/vult/overview/"><i class='fa fa-bullseye'></i> Overview</a></li>
            <li><a href="https://vult-dsp.github.io/vult/tutorials/"><i class='fa fa-book'></i> Docs</a></li>
            <li><a href="https://vult-dsp.github.io/vult/blog/"><i class='fa fa-newspaper-o'></i> Blog</a></li>
            <li><a href="https://vult-dsp.github.io/vult/demo/"><i class='fa fa-code'></i>Demo</a></li>
            <li><a href="https://github.com/vult-dsp/vult"><i class='fa fa-code-fork'></i>Source</a></li>
            <li><a href="https://www.npmjs.com/package/vult"><i class='fa fa-download'></i>Install</a></li>
            <li><a href="https://vult-dsp.com"><i class="fas fa-microchip"></i> Store</a></li>

         </ul>
      </div>
      
   </div>
   
</nav>

<div class="container">
   <div class="row">
      <div class="col-md-2"> </div>
      <div class="col-md-8 col-md-auto">
         <h2>Fixed point computations</h2>
         <p>The Vult language has support for performing fixed-point arithmetics <a href="https://en.wikipedia.org/wiki/Fixed-point_arithmetic">https://en.wikipedia.org/wiki/Fixed-point_arithmetic</a></p>
<p>By default, number representations consist of 16 bits for the decimal part and 16 bits for the integer part. The smallest absolute number that can be represented is 0.0000152588, while the largest is approximately 32768.</p>
<p>Fixed-point numbers prove highly beneficial in microcontrollers lacking a floating-point arithmetic unit, such as Arduino or Raspberry Pi Pico boards. When utilizing fixed-point numbers, the processor conducts computations using integers instead of floating-point numbers, often resulting in increased speed. Check out some of the numbers I obtained in the following links:</p>
<p><a href="https://vult-dsp.github.io/vult/blog/performance-mod/">Performance of mod</a></p>
<p><a href="https://vult-dsp.github.io/vult/blog/tables/">Creation of tables</a></p>
<p>There are two alternatives to use fixed-point code:</p>
<ul>
<li>Full program in fixed-point</li>
<li>Mixed fixed and floating point</li>
</ul>
<h3 id="full-program-in-fixed-point">Full program in fixed-point</h3>
<p>You can generate your code using fixed-point by passing the argument <code>-real fixed</code> as shown below:</p>
<pre tabindex="0"><code>$ vultc -ccode -real fixed test.vult
</code></pre><p>This will replace all computations involving real numbers to fixed-point computations. Take as an example the following code:</p>
<div class="vult_code" id="example1">// file: test.vult
fun foo(d) {
   return 0.00018539226566085504 * exp(0.057762265046662105 * d);
}
//
fun main() {
    val x = 12.5;
    val y = 34.0;
    val z = x + y;
    val w = foo(z);
}
</div>
<p>When generating fixed-point code we get the following C++ code. We can see that all multiplications have been replaced by a call to the function <code>fix_mul</code>, the <code>exp</code> function is now <code>fix_exp</code> and the real numbers have been changed to their corresponding fixed-point representation.</p>
<div class="c_code" id="example2">fix16_t Test_foo(fix16_t d){
   return fix_mul(0xc /* 0.000185 */,fix_exp(fix_mul(0xec9 /* 0.057762 */,d)));
};
//
void Test_main(){
   fix16_t x;
   x = 0xc8000 /* 12.500000 */;
   fix16_t y;
   y = 0x220000 /* 34.000000 */;
   fix16_t z;
   z = (x + y);
   fix16_t w;
   w = Test_foo(z);
}
</div>
<p>One important thing to consider is that fixed-point computations have a larger rounding and trucation error thatn floating point. Some functions like calculating the exponential <code>exp</code> in fixed-point can be slower and less accurate. In that case, I recommend to use lookup tables as shown in <a href="https://vult-dsp.github.io/vult/blog/tables/">Creation of tables</a>. Using lookup tables, the <code>fix_exp</code> is replaced by a couple additions and multiplications.</p>
<p>Since the range of the fixed point numbers is limited some values need to be scaled. Consider the following example where a function takes the samplerate as parameter and has the literal <code>44100.0</code>.</p>
<div class="vult_code" id="example3">fun calculation(hz) {
    return 44100.0 / (2.0 * hz);
}
</div>
<p>If we try to compile this code we get the following error <code> This value '44100.0' cannot be represented with fixed-point numbers</code>.</p>
<p>One way that we could solve this problem is by performing some arithmetic simplifications and writting the expression as <code>(44100.0 / 2.0) / hz</code>. Now the code will compile because <code>44100.0 / 2.0 = 22050.0</code> and is in the fixed-point range. However, there is still a problem. The input to the function <code>hs</code> is given in Hertz and it could be a large value, like <code>44100</code>, <code>48000</code> etc. The only option is to scale the computations: instead of taking Hertz we take kilo Hertz.</p>
<div class="vult_code" id="example4">fun calculation(khz) {
    return 44.10 / (2.0 * hz);
}
</div>
<p>Now all the calculations are in a safe range and the function is still meaningful.</p>
<p>Generally, when dealing with fixed-point numbers, caution is advised against using excessively large or small values. To mitigate such situations, it is recommended to scale the numbers appropriately.</p>
<h3 id="mixed-floating-and-fixed-point">Mixed floating and fixed point</h3>
<p>In the latest version of the Vult compiler, you can seamlessly blend fixed and floating-point arithmetic without the need to generate the entire code in fixed-point. One practical scenario arises when certain calculations demand higher precision or cannot be conveniently scaled within the fixed-point range. Working with fixed-point numbers is straightforward; for literals, appending the postfix <code>x</code> to a number transforms it into fixed-point. Additionally, a new type, aptly named <code>fix16</code>, can be employed in arguments or to explicitly enforce a type on a variable.</p>
<p>In the folowing example, we want the function <code>foo</code> to be calculated using floating-point.</p>
<div class="vult_code" id="example5">
fun foo(d:fix16) : fix16 {
   return fix16(0.00018539226566085504 * exp(0.057762265046662105 * real(d)));
}
<p>fun main() {
val x = 12.5x;
val y = 34.0x;
val z = x + y;
val w = foo(z);
}</p>
</div>
<p>We can use the functions <code>fix16()</code> and <code>real()</code> to convert the values from one numeric type to other. In this case we should NOT call the compiler with the flag <code>-real fixed</code>. This will work fine:</p>
<pre tabindex="0"><code>$ vultc -ccode test.vult
</code></pre><div class="c_code" id="example6">fix16_t Test_foo(fix16_t d){
   return float_to_fix((0.000185392265661f * expf((0.0577622650467f * fix_to_float(d)))));
};
//
void Test_main(){
   fix16_t x;
   x = 0xc8000 /* 12.500000 */;
   fix16_t y;
   y = 0x220000 /* 34.000000 */;
   fix16_t z;
   z = (x + y);
   fix16_t w;
   w = Test_foo(z);
}
</div>
<p>As you see in the code, the <code>Test_foo</code> uses floating-point while the rest of the computations are explicity changed to fixed-point.</p>
<script type="text/javascript" src="../../javascripts/external/ace/ace.js"></script>
<script type="text/javascript" src="../../javascripts/main.js"></script> 
      </div>
   </div>
</div>

<link rel="stylesheet" type="text/css" href="../../css/vult.css">
<div class="container footer">Check our main <a href="https://vult-dsp.com/"> Vult-DSP </a> site</div>